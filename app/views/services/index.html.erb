<% provide(:title, "Host") %>
<div class="wrapper wrapper-content animated fadeInRight">
  <div class="row">

    <div class="col-lg-12">
      <div class="ibox float-e-margins">
        <div class="ibox-title">
          <h5>服务监控</h5>
        </div>

        <div class="ibox-content pl15">
          <div class="bg-search">
            <%=form_tag url_for(action: :index),:class=>"-form-horizontal",:method=>:get do%>
              <div id="rcontent" class="clear-p">

                <div class="col-md-5">
                  <div class="form-group mb0">

                    <input type="text" placeholder="IP" name="keyword" class="form-control pl40" value="<%= params[:keyword] %>">
                    <i class="search-line" style=></i>
                    <i class="fa fa-search search-icon"></i></div>
                </div>
                <div class="col-md-3">
                  <div class="form-group mb0">
                    <%=select_tag(:services,options_for_select(Host.services.invert.to_a,params["services"]),:class=>"form-control chosen-select",multiple: true)%>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group mb0">
                    <%=select_tag(:services,options_for_select(Host.services.invert.to_a,params["services"]),:class=>"form-control chosen-select",multiple: true)%>
                  </div>
                </div>

                <div class="ibox-tools dib">
                  <input type="submit" class="btn btn-primary btn-warning w70 mb0" value="搜索">
                  <!-- <a class="btn btn-primary btn-warning w70 mb0">
                    搜索</a> -->
                </div>
              </div>

            <%end%>
          </div>
        </div>
        <div id="result_release">
          <div class="ibox-content table-sql">
            <ul class="tab-ul clear-p">
              <li class="tab-li active">
                <a href="#" data-target="all-page">全部服务列表</a>
              </li>
            </ul>

            <div class="ibox-content p15-0 all-page table-content">
              <%if !@services.blank?%>
                <table class="table table-striped table-bordered table-hover table-vcenter">
                  <thead>
                    <tr>
                      <th class="text-center">主机IP</th>
                      <th class="text-center">所属位置</th>
                      <th class="text-center">服务名称</th>
                      <th class="text-center">是否在线</th>
                      <th class="text-center">在线时间</th>
                      <th class="text-center">出错时间</th>
                      <th class="text-center">错误内容</th>
                      <th class="text-center">操作</th>
                    </tr>
                  </thead>
                  <tbody class="text-center">
                    <% @services.each do |k, v| %>
                      <% v.each do |vv| %>
                        <tr>
                          <td><%= k%></td>
                          <td><%= vv[0] ? "境内" : "境外"%></td>
                          <td><%= DispatcherHost.service_names[vv[1]]%></td>
                          <% if @running_services[k][vv[1]].blank? %>
                            <td><span class="label label-danger">下线</span></td>
                            <td>未知</td>
                          <% else %>
                            <td>
                              <% if @running_services[k][vv[1]][1] %>
                                <span class="label label-primary">在线</span>
                              <% else %>
                                <span class="label label-danger">下线</span>
                              <% end %>
                            </td>
                            <td>
                              <% if @running_services[k][vv[1]][0] == 0 %>
                                未知
                              <% else %>
                                <%= time_ago_in_words(Time.at(@running_services[k][vv[1]][0])) %>前
                              <% end %>
                            </td>
                          <% end %>
                          <td>
                          <% if vv[2].blank? || vv[2] == 0 || vv[3].blank? %>
                            -
                          <% else %>
                            <%= time_ago_in_words(Time.at(vv[2])) %>
                          <% end %>
                          </td>
                          <td><%= vv[3] %></td>
                          <td class="pos-r">
                            <a href="##">
                              <i class="icon_data_analysis icon-more"></i>
                            </a>
                            <ul class="more-ul dn">
                              <li class="bor-b">
                                <a href="/services/show?ip=<%= k  %>&service_name=<%= vv[1] %>">详情</a>
                              </li>
                            </ul>
                          </td>
                        </tr>
                      <% end %>

                    <% end %>
                  </tbody>
                </table>
                <div class="text-center">
                </div>
              <%else%>
                <%= render "shared/no_data" %>
              <%end%>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!--这里是提示框-->
<div id="modal-form-remove" class="modal fade in" aria-hidden="true">
  <div class="modal-dialog" style="width: 460px;top: 190px;">
    <div class="modal-content">
      <div class="modal-body">
        <div class="row">
          <div class="col-sm-12">
            <h3 class="m-t-none m-b">提示</h3>
            <div class="hr-line-dashed"></div>
            <p class="text-center">
            <strong style="font-size: 14px;">您确定要删除<span class="remove-html"></span>吗？</strong></p>
            <div class="hr-line-dashed"></div>
            <div>
              <button class="btn btn-sm btn-primary pull-right m-t-n-xs sure-remove" type="button" style="margin-left: 20px;">

                <strong>确定</strong></button>
              <button class="btn btn-sm btn-primary pull-right m-t-n-xs cancel-remove" type="button"  style="">

                <strong>取消</strong></button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<% content_for :javascript do %>
  <script>

    $(document)
      .on("click",".tab-li a",function(e){
        e.preventDefault();
        var $this = $(this);
        if ($this.find('.icon-result').length > 0) return;
        var targetClass = $this.data('target');
        var $thisP = $this.closest('.ibox-content');
        $this.closest('li').addClass('active').siblings('li').removeClass('active');
        $thisP.children('.ibox-content').addClass('dn');
        $thisP.children('.' + targetClass).removeClass('dn');
        $('.more-ul').addClass('dn');

        if (targetClass) {
          var url = $this.attr("href");
          if (url != "##") {
            $("#current_url").val(url);
            $.get(url, function (data) {
              $("." + targetClass).html(data);
            })
            return false;
          }
        }
      })
      .on("click",'.icon-more',function(e){
        e.preventDefault();
        var $this = $(this), $thisMoreUl = $this.closest('td').find('.more-ul');
        var isDn = $thisMoreUl.hasClass('dn');
        $('.more-ul').addClass('dn');
        if (isDn) {
          $thisMoreUl.removeClass('dn');
        }
        //点击其他的地方关闭更多
        $(document).on('click', function moreShow(e) {
          var $target = $(e.target)
          if ($target.closest('.pos-r').length == 0) {
            $('.more-ul').addClass('dn');
            $(document).off('click', moreShow);
          }
        })
      })
      .on("click",".remove-line",function(e){

        e.preventDefault();

        //删除本行数据
        //var _$this = $(this);
        var $this = $(this),html = $this.closest('tr').find('td').first().html();
        var $modal = $('#modal-form-remove');
        $modal.find('.remove-html').html(html);
        $modal.modal("show");

        $('.sure-remove').off().on('click', function (e) {
          e.preventDefault();
          var _this=$(this);
          //需要传到数据库中，需要后台传输数据，局部刷新页面
          var url = $this.attr("href");
          if (url != "##") {
            $.ajax({
              url: url,
              type: 'DELETE',
              success:function(data){
                if (data.type=="success"){
                  _this.closest('.modal').modal("hide");
                  $this.closest('tr').remove();
                }
              }});
          }

        });

      }).on("click",'.cancel-remove',function(e){
        var $modal = $('#modal-form-remove');
        $modal.modal("hide");
      });


    $('.chosen-select').chosen({width: "100%",disable_search_threshold: 10000,placeholder_text_multiple:"选择已安装服务",disable_search:true});
    $("[data-toggle='tooltip']").tooltip();

  </script>
<% end %>
