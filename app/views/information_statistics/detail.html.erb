<% provide(:title, "Information") %>
<div class="wrapper wrapper-content animated fadeInRight">
  <div class="row">

    <div class="col-lg-12">
      <div class="ibox float-e-margins">
        <div class="ibox-title">
          <h5>资讯列表</h5>
        </div>

        <div class="ibox-content pl15">
       
        </div>
        <div id="result_release">
          <div class="ibox-content table-sql">
            <ul class="tab-ul clear-p">
            <li class="tab-li active">
              <a href="##" data-target="all-page"><%=@data.ch_name%>-详情</a>
            </li>
              </ul>

            <div class="ibox-content p15-0 all-page table-content">
              <%#= render "list_body" %>
              <table class="table table-striped table-bordered table-hover table-vcenter">
                <tbody class="text-center">
                  <tr>
                    <td>中文名</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>英文名</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>国家</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>域名</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>网站首页</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>来源</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>等级</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>新闻量</td>
                    <td></td>
                  </tr>
                  <tr>
                    <td>备注</td>
                    <td></td>
                  </tr>

                </tbody>
              </table>
            </div>

        </div>
        </div>
      </div>
    </div>
    </div>
  </div>


  <% content_for :javascript do %>
    <script>
$(document)
.on("click",'.icon-more',function(e){
   e.preventDefault();
    var $this = $(this), $thisMoreUl = $this.closest('td').find('.more-ul');
    var isDn = $thisMoreUl.hasClass('dn');
    $('.more-ul').addClass('dn');
    if (isDn) {
      $thisMoreUl.removeClass('dn');
    }
    //点击其他的地方关闭更多
    $(document).on('click', function moreShow(e) {
      var $target = $(e.target)
        if ($target.closest('.pos-r').length == 0) {
          $('.more-ul').addClass('dn');
          $(document).off('click', moreShow);
        }
    })
})
.on('click', '.js-remark, .js-edit-data-source', function(e) {
  e.preventDefault();
  var $this = $(this);
  var isRemark = $this.hasClass('js-remark');
  var hav_infos = $this.data('hav_infos');
  var remark = $this.data('remark');
  var data_source = $this.data('data_source');
  var url = $this.prop('href');
  var $modal = isRemark ? $('#modal_edit_mark') : $('#modal_edit_data_source');
  var $form = $modal.find('form');
  var $remark = $form.find('[name="remark"]');
  var $hav_infos = $form.find('[name="hav_infos"]');
  var $data_source = $form.find('[name="data_source[]"]');
  if(isRemark) {
    $remark.val(remark);
    $hav_infos.filter('[value="'+ hav_infos +'"]').prop('checked',true);
    $form.find('[name="remark"]').val(remark);
  } else {
    (data_source || '').split(',').forEach(function(item) {
      $data_source.children().filter('[value="'+ item +'"]').prop('selected', true);
    });
    $data_source.trigger('chosen:updated');
  }

  $modal.modal({backdrop: 'static', keybaord: false});

  $form.off('submit.edit').on('submit.edit', function(e) {
    e.preventDefault();
    $.ajax({
      method: 'post',
      url: url,
      data: $form.serialize(),
      processData: false,
      dataType: 'json'
    }).done(function(res) {
      if(res.type === 'success') {
        toastr.success(res.message);
        
        var $tr = $this.closest('tr');
        if(isRemark) {
          var hav_infos_val = $hav_infos.filter(':checked').val();
          var new_hav_infos_text = hav_infos_val == '1' ? '有' : hav_infos_val == '0' ? '无' : '不确定';
          $tr.find('td').eq(5).prop('title', $remark.val()).html(new_hav_infos_text);
          $this.data('hav_infos', new_hav_infos_text);
          $this.data('remark', $remark.val());
        } else {
          $tr.find('td').eq(3).html(($data_source.val() || '').join(','));
          $this.data('data_source', ($data_source.val() || '').join(','));
        }

        $modal.modal('hide');

      } else {
        toastr.error(res.message);
      }
    });
  });
});

$('.chosen-select').chosen({width: "100%",disable_search_threshold: 10});

initStartEndDate($('.js-daterange'));
initNumberRange($('.js-number-range'));

function initStartEndDate($wrap) {
  $.fn.datepicker.dates['zh-cn'] = {
    days: ["周日", "周一", "周二", "周三", "周四", "周五", "周六", "周日"],
    daysShort: ["日", "一", "二", "三", "四", "五", "六", "七"],
    daysMin: ["日", "一", "二", "三", "四", "五", "六", "七"],
    months: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],
    monthsShort: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
    today: "今天",
    titleFormat: 'yyyy年 MM',
    clear: "清除"
  };

  var endDate = new Date();
  var startDate = new Date(endDate.getTime() - 15 * 24 * 60 * 60 * 1000);

  var config = {
    language: 'zh-cn',
    format: "yyyy-mm-dd",
    autoclose: true,
    todayHighlight: true,
    endDate: endDate,
    startDate: startDate,
    clearBtn: true,
    container: 'body'
  };

  $wrap.each(function(index, item) {
    var $item = $(item);
    var $datepicker = $item.find('[date-picker]');
    var $start_date = $datepicker.eq(0);
    var $end_date = $datepicker.eq(1);

    initDatePicker($start_date, $end_date);
  });

  function initDatePicker($start_date, $end_date) {
    $start_date.datepicker($.extend(true, {}, config))
    .on('changeDate', function(e) {
      var start = e.date;
      var end = $end_date.datepicker('getDate');
      var startTime = start && start.getTime();
      if(startTime && end && startTime > end.getTime()) {
        $end_date.datepicker('update', start);
      }
    });
    
    $end_date.datepicker($.extend(true, {}, config))
    .on('changeDate', function(e) {
      var start = $start_date.datepicker('getDate');
      var end = e.date;
      var endTime = end && end.getTime();
      if(endTime && start && endTime < start.getTime()) {
        $start_date.datepicker('update', end);
      }
    });
  }
}

function initNumberRange($wrap) {
  $wrap.each(function(index, item) {
    var $item = $(item);
    var $input = $item.find('input');
    var $minInput = $input.eq(0);
    var $maxInput = $input.eq(1);

    $input.on('input.number_input change.number_input', change);

    initNumberInput($minInput, $maxInput);
  });

  function initNumberInput($minInput, $maxInput) {
    $minInput.on('numberChange', function(e, val, isChangeEvent) {
      if(isChangeEvent) {
        var min = val == null ? '' : (val + '');
        var max = $maxInput.val() || '';
        if(min && max && Number(max) < Number(min)) {
          $maxInput.val(min);
        }
      }
    });

    $maxInput.on('numberChange', function(e, val, isChangeEvent) {
      if(isChangeEvent) {
        var min = $minInput.val() || '';
        var max = val == null ? '' : (val + '');
        if(min && max && Number(max) < Number(min)) {
          $minInput.val(max);
        }
      }
    });
  }

  function change(e) {
    var $input = $(e.target);
    var val = ($input.val() || '').trim();
    var isEmptyString = val.length === 0;

    if(isEmptyString) {
      return setValue($input, null);
    }

    if(e.type === 'input') {
      if(val.match(/^(\-0?)$/)) {
        return false;
      }
    }

    val = Number(val);
    isNaN(val) ? $input.val($input.data('currentVal')) : setValue($input, val, e.type === 'change');
  }

  function init($input) {
    var val = $input.val();
    $input.data('currentVal', val);
    if(val.length === 0) {
      setValue($input, null);
    } else {
      val = Number(val);
      isNaN(val) ? $input.val($input.data('currentVal')) : setValue($input, val);
    }
  }

  function setValue($input, val, isChangeEvent) {
    $input.data('currentVal', val);
    $input.val(val);
    $input.trigger('numberChange', [val, isChangeEvent]);
  }
}

    </script>
  <% end %>

